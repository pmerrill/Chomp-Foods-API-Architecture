##
# Global maps
##

# Block unwanted bots
map $http_user_agent $bad_bot {
    default 0;
    ~*Bytedance     1;
    ~*Bytespider    1;
    ~*PetalBot      1;
    ~*Semrush       1;
    ~*SplitSignal   1;
    ~*GPTBot        1;
}

# Rate limiting zones
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;

##
# HTTPS Server
##
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;

    server_name chompthis.com www.chompthis.com;
    root /var/www/html/public;
    index index.php index.html;

    ##
    # SSL (Certbot managed)
    ##
    ssl_certificate     /etc/letsencrypt/live/chompthis.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/chompthis.com/privkey.pem;
    include             /etc/letsencrypt/options-ssl-nginx.conf;
    ssl_dhparam         /etc/letsencrypt/ssl-dhparams.pem;

    ##
    # Security Headers
    ##
    add_header Strict-Transport-Security  "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options            "SAMEORIGIN" always;
    add_header X-Content-Type-Options     "nosniff" always;
    add_header X-XSS-Protection           "1; mode=block" always;
    add_header Referrer-Policy            "strict-origin-when-cross-origin" always;
    add_header Permissions-Policy         "geolocation=(), microphone=(), camera=()" always;

    ##
    # Error pages
    ##
    error_page 404 /error_404.html;
    location = /error_404.html {
        internal;
    }

    error_page 500 502 503 504 /error_50x.html;
    location = /error_50x.html {
        internal;
    }

    ##
    # Main application routing (rate limited)
    ##
    location / {
        # Block bad bots
        if ($bad_bot) {
            return 403;
        }
        
        limit_req zone=general burst=20 nodelay;
        try_files $uri $uri/ /index.php?$args;
    }

    ##
    # PHP handling
    ##
    location ~ \.php$ {
        # Block bad bots
        if ($bad_bot) {
            return 403;
        }
        
        try_files $uri =404;
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php[x]-fpm.sock;
    }

    ##
    # Static assets – long cache, immutable
    ##
    location ~* \.(?:jpg|jpeg|png|gif|ico|svg|webp)$ {
        expires 14d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location ~* \.(?:css|js|woff2?|ttf|eot)$ {
        expires 14d;
        add_header Cache-Control "public, immutable";
        access_log off;
    }

    location ~* \.(?:pdf|txt)$ {
        expires 7d;
        access_log off;
    }

    ##
    # Deny access to hidden and sensitive files
    ##
    location ~ /\. {
        deny all;
        access_log off;
        log_not_found off;
    }

    location ~* (?:composer\.(json|lock)|package(-lock)?\.json|yarn\.lock|\.env)$ {
        deny all;
    }

    ##
    # Gzip compression
    ##
    gzip on;
    gzip_comp_level 5;
    gzip_min_length 256;
    gzip_proxied any;
    gzip_vary on;

    gzip_types
        application/atom+xml
        application/javascript
        application/json
        application/ld+json
        application/manifest+json
        application/rss+xml
        application/vnd.geo+json
        application/vnd.ms-fontobject
        application/x-web-app-manifest+json
        application/xhtml+xml
        application/xml
        image/bmp
        image/svg+xml
        image/x-icon
        text/cache-manifest
        text/css
        text/plain
        text/vcard
        text/vnd.rim.location.xloc
        text/vtt
        text/x-component
        text/x-cross-domain-policy;
}


##
# HTTP → HTTPS redirect
##
server {
    listen 80;
    listen [::]:80;

    server_name chompthis.com www.chompthis.com;
    return 301 https://$host$request_uri;
}